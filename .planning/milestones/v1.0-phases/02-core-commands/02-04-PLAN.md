---
phase: 02-core-commands
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/openclawpack/cli.py
  - tests/test_cli.py
autonomous: true
gap_closure: true
requirements:
  - CMD-01
  - CMD-02
  - CMD-03
  - CMD-04
  - CMD-05
  - CMD-06
  - CMD-07
  - INT-05

must_haves:
  truths:
    - "Running `openclawpack new-project --idea 'build a todo app'` succeeds with exit code 0 (not exit code 2)"
    - "Running `openclawpack status --project-dir .` succeeds with exit code 0"
    - "Running `openclawpack plan-phase --project-dir . 1` succeeds at CLI arg parsing level"
    - "Running `openclawpack execute-phase --verbose 1` succeeds at CLI arg parsing level"
    - "Running `openclawpack --project-dir . status` still works (backward compatibility with global option placement)"
    - "Running `openclawpack new-project 'build a todo app'` still works (backward compatibility with positional arg)"
  artifacts:
    - path: "src/openclawpack/cli.py"
      provides: "CLI with --idea option on new-project and per-command --project-dir/--verbose/--quiet options"
      contains: "idea.*Option"
    - path: "tests/test_cli.py"
      provides: "Typer CliRunner tests for flag placement and --idea option"
      min_lines: 40
  key_links:
    - from: "src/openclawpack/cli.py"
      to: "src/openclawpack/commands/new_project.py"
      via: "CLI new-project command calls new_project_workflow with idea text"
      pattern: "new_project_workflow"
    - from: "src/openclawpack/cli.py"
      to: "src/openclawpack/commands/status.py"
      via: "CLI status command calls status_workflow with project_dir"
      pattern: "status_workflow"
---

<objective>
Fix two CLI interface gaps identified in Phase 2 verification:

1. **Gap 1 (SC-1):** Add `--idea` as a named option on the `new-project` command so that `openclawpack new-project --idea "build a todo app"` works. Keep the positional argument for backward compatibility.
2. **Gap 2 (SC-3, CMD-06, CMD-07):** Add `--project-dir`, `--verbose`, and `--quiet` as per-command options on each `@app.command()` function so that `openclawpack status --project-dir /path` works (options after subcommand name).

Purpose: The ROADMAP Success Criteria and requirements CMD-06/CMD-07 specify these flags on individual commands. The current implementation only supports them as global flags before the subcommand, causing exit code 2 when placed after.

Output: Updated `cli.py` with both fixes and a new `tests/test_cli.py` with Typer CliRunner tests verifying both flag positions.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-commands/02-VERIFICATION.md
@.planning/phases/02-core-commands/02-01-SUMMARY.md
@src/openclawpack/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CLI interface — add --idea option and per-command shared options</name>
  <files>src/openclawpack/cli.py</files>
  <action>
Modify `src/openclawpack/cli.py` to close both verification gaps:

**Gap 1 fix — Add `--idea` named option to new-project command:**
- Change the `new-project` command signature: make `idea` an optional positional argument (default None) AND add `--idea` as a named Option.
- In the function body, resolve the idea text: if `--idea` option is provided, use it; else if positional `idea` is provided, use it; else error with "Provide idea as positional argument or --idea option".
- This ensures both `openclawpack new-project --idea "text"` and `openclawpack new-project "text"` work.
- Typer pattern: `idea: Optional[str] = typer.Argument(None, ...)` plus `idea_opt: Optional[str] = typer.Option(None, "--idea", "-i", ...)`.

**Gap 2 fix — Add per-command --project-dir, --verbose, --quiet options:**
- Add `project_dir`, `verbose`, and `quiet` as explicit `typer.Option` parameters to each of the 4 `@app.command()` functions: `new_project`, `plan_phase`, `execute_phase`, `status`.
- In each command body, resolve the value: use the per-command option if provided, else fall back to `ctx.obj` global value. Pattern: `project_dir = project_dir_opt or ctx.obj.get("project_dir")`.
- Keep the global options on `@app.callback()` so both placements work (before and after subcommand).
- For `--verbose` and `--quiet` booleans, the resolution should be: `verbose = verbose_opt or ctx.obj.get("verbose", False)`.

**Keep all existing functionality intact:**
- Lazy imports inside function bodies (PKG-04).
- `_output()` helper unchanged.
- `version_callback` unchanged.
- `@app.callback()` with global options preserved for backward compatibility.

Do NOT change `--idea-file` — it remains as-is on the new-project command.
  </action>
  <verify>
Run `python -c "from openclawpack.cli import app; from typer.testing import CliRunner; r = CliRunner(); print(r.invoke(app, ['new-project', '--help']).output)"` and confirm `--idea` appears in help text.

Run `python -c "from openclawpack.cli import app; from typer.testing import CliRunner; r = CliRunner(); print(r.invoke(app, ['status', '--help']).output)"` and confirm `--project-dir`, `--verbose`, `--quiet` appear in help text.

Run `pytest tests/ -x -q` — all existing tests still pass (no regressions).
  </verify>
  <done>
- `openclawpack new-project --idea "text"` parses without exit code 2
- `openclawpack status --project-dir .` parses without exit code 2
- `openclawpack plan-phase --verbose 1` parses without exit code 2
- `openclawpack execute-phase --quiet 1` parses without exit code 2
- Backward compatibility: `openclawpack --project-dir . status` still works
- Backward compatibility: `openclawpack new-project "text"` still works
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Typer CliRunner tests for flag placement and --idea option</name>
  <files>tests/test_cli.py</files>
  <action>
Create `tests/test_cli.py` with Typer CliRunner tests that verify both gap fixes at the CLI argument parsing level. These tests should NOT invoke real workflows — mock the workflow functions.

**Import pattern:**
```python
from typer.testing import CliRunner
from openclawpack.cli import app
```

**Mock targets:** Patch workflow functions at their source modules:
- `openclawpack.commands.new_project.new_project_workflow` (async, returns CommandResult)
- `openclawpack.commands.status.status_workflow` (sync, returns CommandResult)
- `openclawpack.commands.plan_phase.plan_phase_workflow` (async, returns CommandResult)
- `openclawpack.commands.execute_phase.execute_phase_workflow` (async, returns CommandResult)

**Test classes:**

1. `TestNewProjectIdeaFlag`:
   - `test_idea_as_named_option`: Invoke `["new-project", "--idea", "build a todo app"]` — exit code 0, workflow called with idea="build a todo app"
   - `test_idea_as_positional_arg`: Invoke `["new-project", "build a todo app"]` — exit code 0, workflow called with idea="build a todo app"
   - `test_idea_option_takes_precedence`: Invoke `["new-project", "ignored positional", "--idea", "preferred"]` — workflow called with idea="preferred"
   - `test_no_idea_errors`: Invoke `["new-project"]` — exit code != 0 (no idea provided)

2. `TestPerCommandOptions`:
   - `test_status_project_dir_after_subcommand`: Invoke `["status", "--project-dir", "."]` — exit code 0, status_workflow called with project_dir="."
   - `test_plan_phase_verbose_after_subcommand`: Invoke `["plan-phase", "--verbose", "1"]` — exit code 0, plan_phase_workflow called with verbose=True
   - `test_execute_phase_quiet_after_subcommand`: Invoke `["execute-phase", "--quiet", "1"]` — exit code 0
   - `test_global_project_dir_still_works`: Invoke `["--project-dir", ".", "status"]` — exit code 0 (backward compatible)

Each test should use `unittest.mock.patch` on the workflow function, provide a mock that returns `CommandResult.ok(result={}, duration_ms=1)`, and assert exit_code == 0 plus verify the workflow was called with the expected arguments.

For async workflow functions, use `AsyncMock` as the mock return and patch `asyncio.run` to call the mock synchronously, OR patch the workflow function itself to return the CommandResult synchronously. Simplest approach: patch the import at the cli module level after lazy import fires.

Actually, the cleanest approach: patch each workflow at its source module path. The CLI does `from openclawpack.commands.new_project import new_project_workflow` inside the function body, so patch `openclawpack.commands.new_project.new_project_workflow` with an `AsyncMock(return_value=CommandResult.ok(...))`.
  </action>
  <verify>Run `pytest tests/test_cli.py -v` — all tests pass, confirming both gap fixes work at the CLI level.</verify>
  <done>
- tests/test_cli.py exists with 8+ tests
- All tests pass confirming --idea option works as named flag
- All tests pass confirming --project-dir/--verbose/--quiet work after subcommand
- Backward compatibility tests pass for global option placement and positional idea arg
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/ -x -q` — full test suite passes (no regressions from cli.py changes)
2. `pytest tests/test_cli.py -v` — all new CLI tests pass
3. Manual check: `python -m openclawpack --version` works (PKG-04 preserved)
4. Manual check: `python -m openclawpack new-project --help` shows both positional IDEA and --idea option
5. Manual check: `python -m openclawpack status --help` shows --project-dir, --verbose, --quiet
</verification>

<success_criteria>
- Both VERIFICATION.md gaps resolved
- `openclawpack new-project --idea "text"` returns exit code 0
- `openclawpack status --project-dir .` returns exit code 0
- Backward compatibility preserved for global option placement
- Backward compatibility preserved for positional idea argument
- All existing 199 tests continue to pass
- 8+ new CLI tests added and passing
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-commands/02-04-SUMMARY.md`
</output>
