---
phase: 05-multi-project-management
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - src/openclawpack/commands/projects.py
  - src/openclawpack/cli.py
  - src/openclawpack/api.py
  - src/openclawpack/__init__.py
  - tests/test_commands/test_projects.py
  - tests/test_api.py
  - tests/test_cli.py
autonomous: true
requirements:
  - STATE-04

must_haves:
  truths:
    - "Running `openclawpack projects add /path` registers the project and outputs JSON confirmation"
    - "Running `openclawpack projects list` shows all registered projects with paths and state"
    - "Running `openclawpack projects remove <name>` deregisters a project and outputs JSON confirmation"
    - "Library consumers can call add_project(), list_projects(), remove_project() as async functions"
    - "New API functions are importable from top-level openclawpack package"
    - "openclawpack --version still works without Claude Code installed (PKG-04)"
  artifacts:
    - path: "src/openclawpack/commands/projects.py"
      provides: "Typer subcommand group with add, list, remove commands"
      exports: ["projects_app"]
    - path: "src/openclawpack/cli.py"
      provides: "Registration of projects_app via add_typer"
      contains: "add_typer"
    - path: "src/openclawpack/api.py"
      provides: "Async add_project, list_projects, remove_project functions"
      exports: ["add_project", "list_projects", "remove_project"]
    - path: "src/openclawpack/__init__.py"
      provides: "Lazy re-exports for new API functions"
      contains: "add_project"
    - path: "tests/test_commands/test_projects.py"
      provides: "Tests for projects CLI subcommands"
      min_lines: 60
  key_links:
    - from: "src/openclawpack/cli.py"
      to: "src/openclawpack/commands/projects.py"
      via: "add_typer(projects_app, name='projects')"
      pattern: "add_typer.*projects_app"
    - from: "src/openclawpack/commands/projects.py"
      to: "src/openclawpack/state/registry.py"
      via: "lazy import of ProjectRegistry in command bodies"
      pattern: "from openclawpack\\.state\\.registry import ProjectRegistry"
    - from: "src/openclawpack/api.py"
      to: "src/openclawpack/state/registry.py"
      via: "lazy import of ProjectRegistry in function bodies"
      pattern: "from openclawpack\\.state\\.registry import ProjectRegistry"
    - from: "src/openclawpack/__init__.py"
      to: "src/openclawpack/api.py"
      via: "__getattr__ lazy re-export"
      pattern: "add_project.*list_projects.*remove_project"
---

<objective>
Create the CLI subcommand group (`openclawpack projects add/list/remove`), async library API functions, and package re-exports for multi-project management.

Purpose: STATE-04 requires projects to be registerable, listable, and removable via CLI commands. This plan wires the ProjectRegistry (from Plan 01) to both the CLI and library API interfaces, completing the multi-project management feature.

Output: Working CLI subcommands, async API functions, and top-level package exports for multi-project CRUD.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-project-management/05-RESEARCH.md
@.planning/phases/05-multi-project-management/05-01-SUMMARY.md
@src/openclawpack/cli.py
@src/openclawpack/api.py
@src/openclawpack/__init__.py
@src/openclawpack/output/schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Projects CLI subcommand group and registration</name>
  <files>
    src/openclawpack/commands/projects.py
    src/openclawpack/cli.py
    tests/test_commands/test_projects.py
    tests/test_cli.py
  </files>
  <action>
Create `src/openclawpack/commands/projects.py` with a Typer subcommand group:

```python
import typer

projects_app = typer.Typer(help="Manage registered projects.")
```

**`projects add` command:**
- Argument: `path` (str, required) -- path to a GSD project directory.
- Option: `--name` / `-n` (str, optional) -- friendly name, defaults to directory basename.
- Option: `--quiet` (bool, default False) -- suppress output.
- Option: `--output-format` (str, default "json") -- output format.
- Body uses lazy import of `ProjectRegistry` from `openclawpack.state.registry`.
- Calls `registry.add(path, name=name)` inside try/except.
- On success: returns CommandResult.ok with the entry's model_dump() as result.
- On ValueError: returns CommandResult.error with the exception message.
- Uses `_output()` helper (import from cli module) or directly handles output internally.
- Access `ctx.obj` for output_format via Typer Context.

**`projects list` command:**
- Option: `--refresh` (bool, default False) -- re-read state from each project's `.planning/` directory.
- Option: `--quiet` (bool, default False).
- Option: `--output-format` (str, default "json").
- Body uses lazy import of `ProjectRegistry`.
- Calls `registry.list_projects()`.
- If `--refresh`, for each entry, call `get_project_summary(entry.path)` inside try/except, update `last_known_state` and `last_checked_at`, then save.
- Returns CommandResult.ok with list of entry.model_dump() dicts.

**`projects remove` command:**
- Argument: `name` (str, required) -- name of the project to remove.
- Option: `--quiet` (bool, default False).
- Option: `--output-format` (str, default "json").
- Body uses lazy import of `ProjectRegistry`.
- Calls `registry.remove(name)`.
- If True: returns CommandResult.ok with {"removed": name}.
- If False: returns CommandResult.error with "Project '{name}' not found in registry.".

All three commands use a local `_output_result()` or inline output logic following the same pattern as the main CLI commands (call `_output()` helper or replicate the pattern inline using `typer.echo(result.to_json())` / `format_text(result)` depending on output_format). Since these commands need access to `output_format` from the parent app's ctx.obj, use `typer.Context` parameter and read from `ctx.obj` (Typer passes parent context to sub-app commands when using `add_typer()`).

Register in `src/openclawpack/cli.py` by adding at the TOP of the commands section (after the helper functions, before `@app.command("new-project")`):

```python
# ── Projects subcommand group ────────────────────────────────────
from openclawpack.commands.projects import projects_app
app.add_typer(projects_app, name="projects")
```

NOTE on PKG-04: The `add_typer()` call imports `projects_app` (a Typer instance), but the command function bodies use lazy imports for ProjectRegistry. The `projects_app` import itself is safe -- it only creates a Typer object, no heavy imports. Verify `openclawpack --version` still works.

**Tests in `tests/test_commands/test_projects.py`:**

Use Typer's `CliRunner` to test all three commands via the main `app`:

1. `openclawpack projects add <tmp_path>` -- returns JSON with success=true, result has name and path.
2. `openclawpack projects add <nonexistent>` -- returns JSON with success=false.
3. `openclawpack projects add <path_without_planning>` -- returns JSON with success=false.
4. `openclawpack projects list` -- after adding a project, returns list with 1 entry.
5. `openclawpack projects list` -- empty registry returns empty list.
6. `openclawpack projects remove <name>` -- after adding, removes successfully.
7. `openclawpack projects remove <nonexistent>` -- returns success=false.

Mock `get_project_summary` to return a predictable dict. Use `tmp_path` for registry file location (pass `registry_path` or monkeypatch `_user_data_dir`).

Add to `tests/test_cli.py`: A test that `openclawpack projects --help` works (verifies add_typer registration).
  </action>
  <verify>
Run `python -m pytest tests/test_commands/test_projects.py -v` -- all tests pass.
Run `python -m pytest tests/test_cli.py -v` -- no regressions, projects help test passes.
Run `openclawpack --version` -- PKG-04 still works.
Run `openclawpack projects --help` -- shows add, list, remove subcommands.
  </verify>
  <done>
Three CLI subcommands (add, list, remove) work via `openclawpack projects`. Add validates paths and detects duplicates. List returns registered projects (with optional --refresh). Remove deletes by name. All return CommandResult JSON. PKG-04 preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Library API functions and package re-exports</name>
  <files>
    src/openclawpack/api.py
    src/openclawpack/__init__.py
    tests/test_api.py
  </files>
  <action>
Add three async functions to `src/openclawpack/api.py` following the established pattern (lazy imports, optional event_bus, CommandResult return):

**`add_project()`:**
```python
async def add_project(
    path: str,
    *,
    name: str | None = None,
    event_bus: EventBus | None = None,
) -> CommandResult:
```
- Lazy import of `ProjectRegistry` inside body.
- `bus = event_bus or EventBus()`
- Try: `registry = ProjectRegistry.load()`, `entry = registry.add(path, name=name)`.
- On success: emit `PROGRESS_UPDATE` with command="add_project", return `CommandResult.ok(result=entry.model_dump())`.
- On ValueError as e: emit `ERROR`, return `CommandResult.error(str(e))`.
- On Exception as e: emit `ERROR`, return `CommandResult.error(str(e))`.

**`list_projects()`:**
```python
async def list_projects(
    *,
    event_bus: EventBus | None = None,
) -> CommandResult:
```
- Lazy import of `ProjectRegistry`.
- `registry = ProjectRegistry.load()`
- `entries = [e.model_dump() for e in registry.list_projects()]`
- Emit `PROGRESS_UPDATE`, return `CommandResult.ok(result=entries)`.
- On Exception: emit `ERROR`, return `CommandResult.error()`.

**`remove_project()`:**
```python
async def remove_project(
    name: str,
    *,
    event_bus: EventBus | None = None,
) -> CommandResult:
```
- Lazy import of `ProjectRegistry`.
- `registry = ProjectRegistry.load()`
- `removed = registry.remove(name)`
- If removed: emit `PROGRESS_UPDATE`, return `CommandResult.ok(result={"removed": name})`.
- If not removed: return `CommandResult.error(f"Project '{name}' not found in registry.")`.
- On Exception: emit `ERROR`, return `CommandResult.error()`.

Update `src/openclawpack/__init__.py`:

1. Add `"add_project"`, `"list_projects"`, `"remove_project"` to `__all__`.
2. Add these names to the `_api_names` set inside `__getattr__`.

**Tests in `tests/test_api.py`:**

Add test cases following the established pattern (mock ProjectRegistry at source):

1. `test_add_project_success` -- mock registry.add returns RegistryEntry, verify CommandResult.ok.
2. `test_add_project_invalid_path` -- mock registry.add raises ValueError, verify CommandResult.error.
3. `test_add_project_emits_event` -- verify PROGRESS_UPDATE event emitted on success, ERROR on failure.
4. `test_list_projects_success` -- mock list_projects returns entries, verify CommandResult.ok with list.
5. `test_list_projects_empty` -- verify empty list on empty registry.
6. `test_remove_project_success` -- mock remove returns True, verify CommandResult.ok.
7. `test_remove_project_not_found` -- mock remove returns False, verify CommandResult.error.
8. `test_remove_project_emits_event` -- verify events emitted.
9. `test_package_imports` -- verify `from openclawpack import add_project, list_projects, remove_project` works.
  </action>
  <verify>
Run `python -m pytest tests/test_api.py -v` -- all tests pass (existing + new).
Run `python -m pytest tests/ -v` -- full suite passes with no regressions.
Run `python -c "from openclawpack import add_project, list_projects, remove_project; print('ok')"` -- prints "ok".
Run `openclawpack --version` -- PKG-04 still works.
  </verify>
  <done>
Three async API functions (add_project, list_projects, remove_project) exist in api.py with event emission. All three are importable from the top-level openclawpack package via lazy __getattr__. Tests pass with no regressions. PKG-04 preserved.
  </done>
</task>

</tasks>

<verification>
- `openclawpack projects add /tmp/test-project` registers a project (with .planning/ dir created)
- `openclawpack projects list` shows the registered project
- `openclawpack projects remove test-project` removes it
- `python -c "from openclawpack import add_project, list_projects, remove_project"` works
- `openclawpack --version` works (PKG-04)
- `python -m pytest tests/ -v` -- full test suite passes
</verification>

<success_criteria>
- `openclawpack projects add/list/remove` commands work end-to-end
- Commands return CommandResult JSON with consistent envelope
- Library API functions (add_project, list_projects, remove_project) are async and emit events
- Functions importable from top-level package
- --quiet suppresses output, --output-format text produces human-readable output
- PKG-04 preserved (openclawpack --version works without Claude Code)
- All tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-project-management/05-02-SUMMARY.md`
</output>
