---
phase: 06-phase4-verification-and-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/openclawpack/api.py
  - tests/test_api.py
  - .planning/phases/04-library-api-and-events/04-VERIFICATION.md
  - .planning/REQUIREMENTS.md
autonomous: true
requirements:
  - INT-01
  - INT-02
  - INT-03
  - INT-04
gap_closure: true

must_haves:
  truths:
    - "DECISION_NEEDED events are emitted when create_project, plan_phase, or execute_phase use default answers (answer_overrides is None)"
    - "DECISION_NEEDED events are NOT emitted when explicit answer_overrides are provided"
    - "All 5 EventType members (phase_complete, plan_complete, error, decision_needed, progress_update) have at least one producer in api.py"
    - "Phase 4 has a VERIFICATION.md that independently confirms INT-01 through INT-04 via code inspection, test evidence, and integration check"
    - "REQUIREMENTS.md traceability shows INT-01 through INT-04 as Complete (not Pending)"
  artifacts:
    - path: "src/openclawpack/api.py"
      provides: "DECISION_NEEDED emission in create_project, plan_phase, execute_phase"
      contains: "EventType.DECISION_NEEDED"
    - path: "tests/test_api.py"
      provides: "Tests for DECISION_NEEDED emission and non-emission"
      contains: "DECISION_NEEDED"
    - path: ".planning/phases/04-library-api-and-events/04-VERIFICATION.md"
      provides: "Phase 4 independent verification document"
      contains: "INT-01"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Updated traceability for INT-01 through INT-04"
      contains: "Complete"
  key_links:
    - from: "src/openclawpack/api.py"
      to: "events/types.py"
      via: "EventType.DECISION_NEEDED import and emit_async call"
      pattern: "emit_async\\(EventType\\.DECISION_NEEDED"
    - from: "tests/test_api.py"
      to: "src/openclawpack/api.py"
      via: "EventBus capture of DECISION_NEEDED events"
      pattern: "bus\\.on\\(EventType\\.DECISION_NEEDED"
    - from: ".planning/phases/04-library-api-and-events/04-VERIFICATION.md"
      to: "src/openclawpack/api.py"
      via: "3-source cross-reference citing code evidence"
      pattern: "INT-03"
---

<objective>
Close the Phase 4 verification gap by wiring the orphaned DECISION_NEEDED event emission and producing independent verification for all four INT-* requirements.

Purpose: The v1.0 milestone audit identified that DECISION_NEEDED is defined as an EventType but never emitted by any producer, and Phase 4 lacks a VERIFICATION.md. This plan fixes the code gap (INT-03 compliance) and creates the missing verification document (INT-01 through INT-04 confirmation), moving the milestone score from 26/30 to 30/30.

Output: Updated api.py with DECISION_NEEDED emission, new tests in test_api.py, Phase 4 VERIFICATION.md, updated REQUIREMENTS.md traceability.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-phase4-verification-and-fix/06-RESEARCH.md
@.planning/v1.0-MILESTONE-AUDIT.md
@.planning/phases/04-library-api-and-events/04-01-SUMMARY.md
@.planning/phases/04-library-api-and-events/04-02-SUMMARY.md
@src/openclawpack/api.py
@tests/test_api.py
@src/openclawpack/events/types.py
@src/openclawpack/events/bus.py
@src/openclawpack/events/cli_handler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DECISION_NEEDED emission to api.py and tests</name>
  <files>
    src/openclawpack/api.py
    tests/test_api.py
  </files>
  <action>
    Add DECISION_NEEDED event emission to the three API functions that use answer injection with default answers: create_project(), plan_phase(), and execute_phase().

    **In src/openclawpack/api.py:**

    For each of the three functions (create_project, plan_phase, execute_phase), add an emit_async call for EventType.DECISION_NEEDED BEFORE the workflow call, when `answer_overrides` is None. This follows the pattern established in the research:

    ```python
    # In create_project(), after `bus = event_bus or EventBus()` and BEFORE the workflow call:
    if not answer_overrides:
        await bus.emit_async(EventType.DECISION_NEEDED, {
            "command": "create_project",
            "reason": "using_default_answers",
            "message": "Project creation using default GSD configuration answers",
        })
    ```

    Apply the same pattern to plan_phase() (command="plan_phase", message="Phase planning using default GSD confirmation answers") and execute_phase() (command="execute_phase", message="Phase execution using default GSD checkpoint answers").

    The emission goes BEFORE the workflow call because it signals "decisions are being auto-resolved by the injection system" -- by the time the workflow completes, it is too late for a consumer to act on it.

    Do NOT emit DECISION_NEEDED in get_status(), add_project(), list_projects(), or remove_project() -- these functions have no answer injection and no decision points.

    Do NOT add event_bus parameters to engine.py, answers.py, or any transport layer file. The EventBus stays in api.py only (per established architecture).

    Do NOT import NEW_PROJECT_DEFAULTS or other answer maps at module level in api.py -- this would break PKG-04. The `if not answer_overrides` check is sufficient.

    **In tests/test_api.py:**

    Add 6 new tests across the three test classes:

    1. TestCreateProject.test_emits_decision_needed_when_no_overrides -- call create_project("idea", event_bus=bus) without answer_overrides. Assert exactly 1 DECISION_NEEDED event captured with data["command"] == "create_project".

    2. TestCreateProject.test_no_decision_needed_when_overrides_provided -- call create_project("idea", answer_overrides={"key": "val"}, event_bus=bus). Assert 0 DECISION_NEEDED events captured.

    3. TestPlanPhase.test_emits_decision_needed_when_no_overrides -- call plan_phase(1, event_bus=bus). Assert 1 DECISION_NEEDED event with data["command"] == "plan_phase".

    4. TestPlanPhase.test_no_decision_needed_when_overrides_provided -- call plan_phase(1, answer_overrides={"key": "val"}, event_bus=bus). Assert 0 DECISION_NEEDED events.

    5. TestExecutePhase.test_emits_decision_needed_when_no_overrides -- call execute_phase(1, event_bus=bus). Assert 1 DECISION_NEEDED event with data["command"] == "execute_phase".

    6. TestExecutePhase.test_no_decision_needed_when_overrides_provided -- call execute_phase(1, answer_overrides={"key": "val"}, event_bus=bus). Assert 0 DECISION_NEEDED events.

    Each test should follow the established pattern in the file: register a handler for EventType.DECISION_NEEDED on a new EventBus, patch the workflow function with AsyncMock returning _ok_result(), call the API function, and assert on captured events.

    Verify existing tests still pass -- the new DECISION_NEEDED emission should NOT break existing tests because they register handlers for specific EventType values (PROGRESS_UPDATE, PLAN_COMPLETE, etc.), not for DECISION_NEEDED.
  </action>
  <verify>
    Run: `cd /Users/mit/Documents/GitHub/openclawpack && python -m pytest tests/test_api.py -v`
    All existing tests plus 6 new tests must pass.

    Run: `cd /Users/mit/Documents/GitHub/openclawpack && python -m pytest tests/ -x -q`
    Full test suite must pass with zero regressions.

    Run: `cd /Users/mit/Documents/GitHub/openclawpack && python -c "from openclawpack.api import create_project; print('PKG-04 OK')"`
    Must print "PKG-04 OK" without error (lazy import still works).

    Run: `cd /Users/mit/Documents/GitHub/openclawpack && grep -c 'DECISION_NEEDED' src/openclawpack/api.py`
    Must return 3 (one occurrence per function: create_project, plan_phase, execute_phase).
  </verify>
  <done>
    - DECISION_NEEDED events emitted in create_project, plan_phase, and execute_phase when answer_overrides is None
    - DECISION_NEEDED events NOT emitted when answer_overrides is provided
    - 6 new tests pass (2 per function: with-defaults, with-overrides)
    - All existing tests pass with zero regressions
    - PKG-04 preserved (openclawpack --version works without SDK)
    - All 5 EventType members now have at least one producer in api.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Phase 4 VERIFICATION.md and update REQUIREMENTS.md traceability</name>
  <files>
    .planning/phases/04-library-api-and-events/04-VERIFICATION.md
    .planning/REQUIREMENTS.md
  </files>
  <action>
    **Create .planning/phases/04-library-api-and-events/04-VERIFICATION.md:**

    Create a comprehensive verification document that independently confirms INT-01 through INT-04 are satisfied. Follow the established format from Phase 1/3/5 VERIFICATION.md files.

    The document must include:

    1. **Header** with verified date, phase status (Complete), and note that this is a re-verification performed in Phase 6.

    2. **Success Criteria Verification** -- one section per Phase 4 success criterion from ROADMAP.md:
       - SC-1 (INT-01): Verify create_project, plan_phase, execute_phase, get_status are importable async functions in api.py. Evidence: `inspect.iscoroutinefunction()` tests pass, `from openclawpack import create_project` works.
       - SC-2 (INT-02): Verify get_status returns CommandResult with ProjectStatus typed model. Evidence: test_converts_dict_to_project_status passes, ProjectStatus is Pydantic BaseModel.
       - SC-3 (INT-03): Verify all 5 event types have producers. Evidence: PROGRESS_UPDATE (create_project, get_status, add/list/remove), PLAN_COMPLETE (plan_phase), PHASE_COMPLETE (execute_phase), ERROR (all functions), DECISION_NEEDED (create_project, plan_phase, execute_phase -- added in Phase 6). 29 event system tests + 6 new DECISION_NEEDED tests pass.
       - SC-4 (INT-04): Verify hooks work in library mode (EventBus.on() + emit_async) and CLI mode (_make_cli_bus() + cli_json_handler to stderr). Evidence: test_api.py tests for library mode, test_cli.py tests for CLI bus wiring, _make_cli_bus registers handler on ALL 5 EventType members.

    3. **Requirement Completion** table with INT-01 through INT-04, all marked COMPLETE.

    4. **Test Coverage** table listing test files and test counts relevant to Phase 4 requirements (test_events/, test_api.py, test_cli.py).

    5. **Plans Completed** checklist (04-01, 04-02 as complete, plus note about Phase 6 gap closure).

    Use 3-source cross-reference for each requirement:
    - Source 1: Code inspection (file paths, function signatures, emit calls)
    - Source 2: Test evidence (test names, assertions, pass counts)
    - Source 3: Integration check (import chains, EventBus wiring, CLI handler registration)

    **Update .planning/REQUIREMENTS.md:**

    In the Traceability table at the bottom:
    - Change INT-01 status from "Pending" to "Complete"
    - Change INT-02 status from "Pending" to "Complete"
    - Change INT-03 status from "Pending" to "Complete"
    - Change INT-04 status from "Pending" to "Complete"

    In the v1 Requirements Integration section:
    - Change the `[ ]` checkboxes for INT-01, INT-02, INT-03, INT-04 to `[x]`

    Also update the 6 other stale traceability entries (these are already satisfied per the milestone audit, just stale):
    - TRNS-05: Pending -> Complete
    - TRNS-06: Pending -> Complete
    - CMD-05: Pending -> Complete
    - CMD-07: Pending -> Complete
    - OUT-03: Pending -> Complete
    - OUT-04: Pending -> Complete

    This fixes all 10 stale "Pending" entries identified in the milestone audit.
  </action>
  <verify>
    Run: `test -f .planning/phases/04-library-api-and-events/04-VERIFICATION.md && echo "EXISTS" || echo "MISSING"`
    Must print "EXISTS".

    Run: `grep -c "COMPLETE" .planning/phases/04-library-api-and-events/04-VERIFICATION.md`
    Must return at least 4 (one per INT-* requirement).

    Run: `grep -c "Pending" .planning/REQUIREMENTS.md`
    Must return 0 (all stale Pending entries fixed).

    Run: `grep "INT-01" .planning/REQUIREMENTS.md | grep "Complete"`
    Must match (INT-01 shows Complete).

    Run: `grep "\[x\]" .planning/REQUIREMENTS.md | grep -c "INT-"`
    Must return 4 (all 4 INT-* requirements checked).
  </verify>
  <done>
    - Phase 4 VERIFICATION.md exists with 3-source cross-reference for INT-01, INT-02, INT-03, INT-04
    - All 4 requirements confirmed as COMPLETE in verification document
    - REQUIREMENTS.md traceability updated: INT-01 through INT-04 changed from Pending to Complete
    - REQUIREMENTS.md traceability updated: 6 other stale Pending entries (TRNS-05, TRNS-06, CMD-05, CMD-07, OUT-03, OUT-04) changed to Complete
    - Zero stale "Pending" entries remain in REQUIREMENTS.md traceability table
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_api.py -v` -- all tests pass including 6 new DECISION_NEEDED tests
2. `python -m pytest tests/ -x -q` -- full suite passes with zero regressions
3. `grep -c 'emit_async(EventType.DECISION_NEEDED' src/openclawpack/api.py` returns 3
4. `grep -c 'Pending' .planning/REQUIREMENTS.md` returns 0
5. Phase 4 VERIFICATION.md exists and covers INT-01 through INT-04
6. `openclawpack --version` works (PKG-04 preserved)
</verification>

<success_criteria>
- All 5 EventType members have producers in api.py (DECISION_NEEDED was the missing one)
- 6 new tests confirm DECISION_NEEDED emission behavior
- Phase 4 VERIFICATION.md provides independent 3-source confirmation of INT-01 through INT-04
- REQUIREMENTS.md traceability is fully up-to-date (0 stale Pending entries)
- Full test suite passes with zero regressions
- v1.0 milestone audit score moves from 26/30 to 30/30
</success_criteria>

<output>
After completion, create `.planning/phases/06-phase4-verification-and-fix/06-01-SUMMARY.md`
</output>
