---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/openclawpack/transport/__init__.py
  - src/openclawpack/transport/errors.py
  - src/openclawpack/transport/types.py
  - src/openclawpack/transport/client.py
  - tests/test_transport/__init__.py
  - tests/test_transport/test_errors.py
  - tests/test_transport/test_client.py
autonomous: true
requirements:
  - TRNS-01
  - TRNS-02
  - TRNS-03
  - TRNS-04

must_haves:
  truths:
    - "ClaudeTransport can spawn a Claude Code subprocess via the SDK, send a prompt, and return a CommandResult"
    - "Subprocess has configurable timeout that raises TransportTimeout on expiry"
    - "A long-running prompt completes without deadlock or hanging -- stdout and stderr are consumed concurrently by the SDK's async iterator (verified via slow-marked integration test)"
    - "Typed exceptions (CLINotFound, ProcessError, TransportTimeout, JSONDecodeError) are raised for distinct failure modes and callers can catch them specifically"
  artifacts:
    - path: "src/openclawpack/transport/errors.py"
      provides: "Typed exception hierarchy for transport failures"
      exports: ["TransportError", "CLINotFound", "ProcessError", "TransportTimeout", "JSONDecodeError"]
    - path: "src/openclawpack/transport/types.py"
      provides: "TransportConfig dataclass for subprocess configuration"
      exports: ["TransportConfig"]
    - path: "src/openclawpack/transport/client.py"
      provides: "ClaudeTransport adapter wrapping claude-agent-sdk"
      exports: ["ClaudeTransport"]
  key_links:
    - from: "src/openclawpack/transport/client.py"
      to: "claude-agent-sdk"
      via: "import and call sdk_query / ClaudeAgentOptions"
      pattern: "from claude_agent_sdk import"
    - from: "src/openclawpack/transport/client.py"
      to: "src/openclawpack/transport/errors.py"
      via: "catches SDK exceptions, re-raises as typed transport errors"
      pattern: "raise (CLINotFound|ProcessError|TransportTimeout|JSONDecodeError)"
    - from: "src/openclawpack/transport/client.py"
      to: "src/openclawpack/output/schema.py"
      via: "constructs CommandResult from SDK ResultMessage"
      pattern: "CommandResult\\("
---

<objective>
Build the transport layer that wraps claude-agent-sdk behind an adapter interface, providing subprocess spawning, timeout handling, and typed error classification.

Purpose: Enable all future commands to communicate with Claude Code through a stable adapter interface that isolates the SDK's v0.1.x API from the rest of the codebase. The adapter translates SDK messages and exceptions into openclawpack's own types.

Output: Working transport adapter with configurable timeout, typed exception hierarchy, and CommandResult output integration.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create exception hierarchy and transport config</name>
  <files>
    src/openclawpack/transport/errors.py
    src/openclawpack/transport/types.py
    tests/test_transport/__init__.py
    tests/test_transport/test_errors.py
  </files>
  <action>
    Create the typed exception hierarchy and configuration types for the transport layer.

    **src/openclawpack/transport/errors.py:**

    Define exception hierarchy (all inherit from base):

    `TransportError(Exception)`: Base exception for all transport failures. Stores `message: str`.

    `CLINotFound(TransportError)`: Raised when Claude Code CLI is not found on the system. This maps from SDK's `CLINotFoundError`. Message should suggest installation: "Claude Code CLI not found. Install with: npm install -g @anthropic-ai/claude-code"

    `ProcessError(TransportError)`: Raised when the subprocess exits with non-zero code. Stores `exit_code: int | None = None` and `stderr: str | None = None`. Maps from SDK's `ProcessError`.

    `TransportTimeout(TransportError)`: Raised when subprocess exceeds configured timeout. Stores `timeout_seconds: float`. Maps from Python's `TimeoutError` / `asyncio.TimeoutError`.

    `JSONDecodeError(TransportError)`: Raised when subprocess output contains malformed JSON. Stores `raw_output: str | None = None`. Maps from SDK's `CLIJSONDecodeError`.

    `ConnectionError_(TransportError)`: Raised when connection to subprocess is lost. Maps from SDK's `CLIConnectionError`. (Trailing underscore avoids shadowing builtin.)

    Each exception should have a descriptive `__str__` that includes the stored context fields.

    **src/openclawpack/transport/types.py:**

    `TransportConfig` dataclass (use `@dataclass` from dataclasses, NOT Pydantic -- this is configuration, not validated data):
    - `cwd: str | None = None` -- working directory for subprocess
    - `timeout_seconds: float = 300.0` -- subprocess timeout (5 min default)
    - `allowed_tools: list[str] | None = None` -- tools Claude can use
    - `system_prompt: str | None = None` -- optional system prompt override
    - `cli_path: str | None = None` -- path to Claude CLI binary (None = auto-detect)
    - `permission_mode: str = "bypassPermissions"` -- SDK permission mode

    **tests/test_transport/test_errors.py:**
    - Test each exception type is a subclass of TransportError
    - Test each exception type is catchable independently (try/except CLINotFound should not catch ProcessError)
    - Test exception string representation includes context (exit_code, timeout_seconds, etc.)
    - Test TransportError can be used as a catch-all for all transport exceptions
  </action>
  <verify>
    Run: `cd /Users/mit/Documents/GitHub/openclawpack && python -m pytest tests/test_transport/test_errors.py -v` -- all tests pass.
    Run: `python -c "from openclawpack.transport.errors import *; raise CLINotFound()"` -- raises CLINotFound with install suggestion message.
  </verify>
  <done>Exception hierarchy correctly distinguishes 5 failure modes. All exceptions inherit from TransportError. TransportConfig provides sensible defaults. Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create ClaudeTransport adapter wrapping claude-agent-sdk</name>
  <files>
    src/openclawpack/transport/client.py
    src/openclawpack/transport/__init__.py
    tests/test_transport/test_client.py
  </files>
  <action>
    Create the transport adapter that wraps claude-agent-sdk behind a stable interface. This is the ONLY file in the codebase that imports from `claude_agent_sdk` directly.

    **src/openclawpack/transport/client.py:**

    `ClaudeTransport` class:
    - `__init__(self, config: TransportConfig | None = None)`: Store config, default to `TransportConfig()`.

    - `async def run(self, prompt: str, **kwargs) -> CommandResult`: Main execution method.
      - Build `ClaudeAgentOptions` from config (cwd, allowed_tools, permission_mode, cli_path)
      - Override options with any kwargs (e.g., `cwd=kwargs.get("cwd", self.config.cwd)`)
      - Wrap SDK `query()` call in `asyncio.timeout(self.config.timeout_seconds)` (Python 3.11+ pattern per research)
      - Iterate async messages from `query()`, collect `AssistantMessage` text blocks, capture `ResultMessage`
      - If no `ResultMessage` received after iteration completes, raise `ProcessError("No result message received from Claude Code")` (pitfall 3 from research)
      - Convert `ResultMessage` to `CommandResult`:
        - `success = not result_message.is_error`
        - `result = result_message.result` (the text content)
        - `errors = [result_message.result] if result_message.is_error else []`
        - `session_id = result_message.session_id`
        - `usage = result_message.usage` (dict with token counts)
        - `duration_ms = result_message.duration_ms`
      - Exception mapping (in try/except):
        - `CLINotFoundError` -> `CLINotFound`
        - `SDKProcessError` -> `ProcessError` (preserve exit_code, stderr)
        - `CLIJSONDecodeError` -> `JSONDecodeError`
        - `CLIConnectionError` -> `ConnectionError_`
        - `TimeoutError` (from asyncio.timeout) -> `TransportTimeout`
      - Do NOT catch bare `Exception` -- let unexpected errors propagate

    - `def run_sync(self, prompt: str, **kwargs) -> CommandResult`: Synchronous wrapper.
      - Uses `anyio.from_thread.run()` or `anyio.run()` to bridge sync-to-async (per research pitfall 2)
      - This is what CLI commands will call

    **src/openclawpack/transport/__init__.py:**
    - Export: `ClaudeTransport`, `TransportConfig`, `TransportError`, `CLINotFound`, `ProcessError`, `TransportTimeout`, `JSONDecodeError`, `ConnectionError_`
    - Use lazy imports for `ClaudeTransport` to avoid importing claude-agent-sdk at module load time:
      ```python
      def __getattr__(name):
          if name == "ClaudeTransport":
              from openclawpack.transport.client import ClaudeTransport
              return ClaudeTransport
          raise AttributeError(f"module {__name__!r} has no attribute {name!r}")
      ```
    - Direct imports for errors and types (they don't depend on SDK)

    **tests/test_transport/test_client.py:**
    - Test `ClaudeTransport` instantiates with default config
    - Test `ClaudeTransport` instantiates with custom config (custom timeout, custom cwd)
    - Test that importing `openclawpack.transport` does NOT import claude-agent-sdk (verify by checking `sys.modules` does not contain `claude_agent_sdk` after import)
    - Test that accessing `ClaudeTransport` class DOES trigger the lazy import
    - Test `TransportConfig` defaults: timeout=300, permission_mode="bypassPermissions"
    - Note: Do NOT test actual SDK calls in the default test suite (requires Claude Code installed and authenticated). Focus on unit testing the adapter's construction, config handling, and lazy import behavior.
    - Add ONE slow-marked integration test (`@pytest.mark.slow`) that, when Claude Code IS available, sends a trivial prompt (e.g., "respond with 'hello'") and asserts: (a) no deadlock/hang (completes within timeout), (b) returns a CommandResult with success=True. This covers TRNS-03 (concurrent I/O). Guard the test with `pytest.importorskip("claude_agent_sdk")` and skip if Claude CLI is not on PATH. Do NOT run this test in the default `pytest` invocation -- it requires `-m slow`.
  </action>
  <verify>
    Run: `cd /Users/mit/Documents/GitHub/openclawpack && python -m pytest tests/test_transport/ -v` -- all tests pass.
    Run: `python -c "import sys; import openclawpack.transport; assert 'claude_agent_sdk' not in sys.modules; print('Lazy import works')"` -- confirms SDK not loaded at import time.
    Run: `python -c "from openclawpack.transport import TransportConfig; c = TransportConfig(timeout_seconds=60); print(f'Timeout: {c.timeout_seconds}s')"` -- prints "Timeout: 60s".
  </verify>
  <done>ClaudeTransport adapter wraps SDK behind stable interface. Exception mapping covers all 5 failure modes. Lazy import prevents SDK loading until needed. Config provides sensible defaults. All tests pass.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_transport/ -v` -- all tests pass
2. Importing `openclawpack.transport` does NOT load claude-agent-sdk
3. All 5 exception types are independently catchable and inherit from TransportError
4. TransportConfig provides configurable timeout, cwd, tools, permission mode
5. ClaudeTransport.run() maps SDK messages to CommandResult and SDK exceptions to typed errors
</verification>

<success_criteria>
- Transport adapter is the single point of SDK dependency (no other file imports claude_agent_sdk)
- Exception hierarchy provides typed classification for CLINotFound, ProcessError, Timeout, JSONDecode, Connection failures
- Configurable timeout with graceful termination via asyncio.timeout
- Lazy import ensures --version/--help work without SDK
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
