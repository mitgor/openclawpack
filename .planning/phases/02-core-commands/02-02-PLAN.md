---
phase: 02-core-commands
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/openclawpack/commands/status.py
  - src/openclawpack/commands/new_project.py
  - tests/test_commands/test_status.py
  - tests/test_commands/test_new_project.py
autonomous: true
requirements:
  - CMD-01
  - CMD-04

must_haves:
  truths:
    - "Running `openclawpack status --project-dir /path/to/project` returns structured JSON with current_phase, progress_percent, blockers, and requirement completion counts"
    - "Running `openclawpack status` on a directory without .planning/ returns a CommandResult with success=false and a descriptive error"
    - "Running `openclawpack new-project --idea 'build a todo app'` invokes the GSD new-project workflow non-interactively with answer injection for config questions"
    - "The new-project command accepts both inline text (--idea) and file path (--idea-file) for the project idea"
  artifacts:
    - path: "src/openclawpack/commands/status.py"
      provides: "status_workflow() function calling get_project_summary and wrapping in CommandResult"
      exports: ["status_workflow"]
    - path: "src/openclawpack/commands/new_project.py"
      provides: "new_project_workflow() function with answer map defaults for GSD config questions"
      exports: ["new_project_workflow", "NEW_PROJECT_DEFAULTS"]
    - path: "tests/test_commands/test_status.py"
      provides: "Tests for status workflow against real and missing .planning/ directories"
    - path: "tests/test_commands/test_new_project.py"
      provides: "Tests for new-project workflow prompt construction and answer map assembly"
  key_links:
    - from: "src/openclawpack/commands/status.py"
      to: "src/openclawpack/state/reader.py"
      via: "status_workflow calls get_project_summary()"
      pattern: "get_project_summary"
    - from: "src/openclawpack/commands/new_project.py"
      to: "src/openclawpack/commands/engine.py"
      via: "new_project_workflow calls WorkflowEngine.run_gsd_command()"
      pattern: "run_gsd_command"
    - from: "src/openclawpack/commands/new_project.py"
      to: "src/openclawpack/commands/answers.py"
      via: "new_project_workflow uses answer map with build_answer_callback"
      pattern: "NEW_PROJECT_DEFAULTS"
---

<objective>
Implement the status and new-project command workflows. Status is a local-only command that reads .planning/ state and returns structured JSON. New-project invokes the GSD `/gsd:new-project --auto` workflow via the workflow engine with pre-filled answers for configuration questions.

Purpose: These two commands represent the extremes of complexity -- status is the simplest (no subprocess) and new-project is the most complex (longest running, most config questions). Implementing both proves the workflow engine works for local-only and subprocess-backed commands.

Output: Working status and new-project commands with tests.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-commands/02-RESEARCH.md
@.planning/phases/02-core-commands/02-01-SUMMARY.md
@src/openclawpack/commands/engine.py
@src/openclawpack/commands/answers.py
@src/openclawpack/cli.py
@src/openclawpack/state/reader.py
@src/openclawpack/output/schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement status workflow with tests</name>
  <files>
    src/openclawpack/commands/status.py
    tests/test_commands/test_status.py
  </files>
  <action>
    **Create `src/openclawpack/commands/status.py`:**

    Contains `status_workflow(project_dir: str | None = None) -> CommandResult`:
    - Takes an optional `project_dir` (defaults to `os.getcwd()`)
    - Calls `get_project_summary(project_dir)` from the state module
    - Wraps the result dict in `CommandResult.ok(result=summary, duration_ms=elapsed)`
    - On `FileNotFoundError`, returns `CommandResult.error(message=str(e), duration_ms=elapsed)`
    - Uses `time.monotonic()` to measure duration_ms
    - This is a synchronous function (no async needed — it reads local files only)

    The function should NOT import state modules at module level. Use a function-level import:
    ```python
    def status_workflow(project_dir: str | None = None) -> CommandResult:
        import time
        from openclawpack.state.reader import get_project_summary
        ...
    ```

    **Create `tests/test_commands/test_status.py`:**

    Tests (all should work without Claude Code installed):
    1. `test_status_returns_project_summary` — create a temp .planning/ dir with minimal STATE.md and PROJECT.md, verify CommandResult.success is True and result dict has expected keys
    2. `test_status_missing_planning_dir` — call with a temp dir that has no .planning/, verify success=False and errors contains descriptive message
    3. `test_status_default_project_dir` — verify it defaults to cwd when project_dir is None (mock os.getcwd)
    4. `test_status_duration_tracked` — verify duration_ms is > 0 in the result
    5. `test_status_result_has_all_fields` — verify the result dict contains: current_phase, current_phase_name, progress_percent, blockers, requirements_complete, requirements_total

    Use the same temp directory fixtures from test_reader.py as a pattern — create minimal .planning/ dirs with STATE.md and PROJECT.md content.
  </action>
  <verify>
    Run `python -m pytest tests/test_commands/test_status.py -v` — all tests pass.
    Run `openclawpack status --project-dir .` (from the openclawpack project root which HAS .planning/) — returns valid JSON with project state.
  </verify>
  <done>
    `openclawpack status` returns structured JSON with current phase, progress, blockers, and requirement counts. Missing .planning/ directories produce error results instead of crashes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement new-project workflow with answer map and tests</name>
  <files>
    src/openclawpack/commands/new_project.py
    tests/test_commands/test_new_project.py
  </files>
  <action>
    **Create `src/openclawpack/commands/new_project.py`:**

    Contains:

    1. `NEW_PROJECT_DEFAULTS` dict — default answers for GSD new-project config questions (from research Pitfall 3). Use substring keys for fuzzy matching:
       ```python
       NEW_PROJECT_DEFAULTS: dict[str, str] = {
           "depth": "3",
           "parallelization": "Yes",
           "git": "Yes",
           "research": "Standard",
           "plan check": "Yes",
           "verif": "Yes",
           "model": "quality",
       }
       ```

    2. `async def new_project_workflow(idea: str, project_dir: str | None = None, verbose: bool = False, quiet: bool = False, timeout: float | None = None, answer_overrides: dict[str, str] | None = None) -> CommandResult`:
       - If `idea` looks like a file path (Path(idea).is_file()), read the file content as the idea text
       - Build answer map by merging defaults with overrides: `{**NEW_PROJECT_DEFAULTS, **(answer_overrides or {})}`
       - Construct prompt: `f"/gsd:new-project --auto\n\n{idea_text}"`
       - Create WorkflowEngine with project_dir, verbose, quiet, timeout
       - Call `await engine.run_gsd_command("gsd:new-project", prompt_override=prompt, answer_map=answer_map)`
         Note: The engine may need a `prompt_override` parameter for cases where the prompt is not just the command name + args. If the engine from 02-01 doesn't support this, pass the full prompt differently — e.g., use empty command with the full prompt as prompt_args, OR add a `raw_prompt` kwarg to run_gsd_command. Document whichever approach is used.
       - Return the CommandResult

    3. `def new_project_workflow_sync(...)` — sync wrapper using `anyio.from_thread.run()`

    IMPORTANT: All imports from commands.engine, commands.answers, and transport should be inside the function body (lazy imports for PKG-04 compliance).

    **Create `tests/test_commands/test_new_project.py`:**

    Tests (mock the transport layer — do NOT call real Claude Code):
    1. `test_new_project_prompt_construction` — verify the prompt starts with `/gsd:new-project --auto` and contains the idea text
    2. `test_new_project_reads_idea_file` — create a temp file with idea text, pass file path as idea, verify file content is used in prompt
    3. `test_new_project_plain_text_idea` — pass plain text, verify it is used directly (not treated as file path)
    4. `test_new_project_default_answers` — verify NEW_PROJECT_DEFAULTS is used when no overrides provided
    5. `test_new_project_answer_overrides` — verify answer_overrides merge with and override defaults
    6. `test_new_project_timeout_default` — verify default timeout is 900s for new-project
    7. `test_new_project_project_dir_propagation` — verify project_dir is passed to WorkflowEngine

    Use `unittest.mock.patch` to mock `WorkflowEngine.run_gsd_command` and capture the arguments it receives. Do NOT test the actual GSD invocation.
  </action>
  <verify>
    Run `python -m pytest tests/test_commands/test_new_project.py -v` — all tests pass.
    Run `python -m pytest tests/test_commands/ -v` — all command tests pass.
    Run `openclawpack new-project --help` — shows usage with idea argument and options.
  </verify>
  <done>
    `openclawpack new-project --idea "build a todo app"` constructs correct GSD prompt with answer injection for config questions. File-based ideas are auto-detected and read. Default answers for depth, parallelization, git tracking, etc. are provided with override support. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_commands/test_status.py tests/test_commands/test_new_project.py -v` — all tests pass
2. `openclawpack status --project-dir .` — returns valid JSON with this project's state (since it has .planning/)
3. `openclawpack status --project-dir /tmp` — returns error JSON (no .planning/ dir)
4. `openclawpack new-project --help` — shows idea argument and options
5. `python -m pytest tests/ -v` — full suite still passes
</verification>

<success_criteria>
- status command reads .planning/ state locally and returns structured CommandResult JSON
- status command handles missing .planning/ gracefully with error result
- new-project command constructs `/gsd:new-project --auto` prompt with idea text
- new-project accepts both inline text and file paths for idea
- new-project pre-fills GSD config question answers with sensible defaults
- Answer overrides allow customizing default answers
- All tests pass without requiring Claude Code
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-commands/02-02-SUMMARY.md`
</output>
