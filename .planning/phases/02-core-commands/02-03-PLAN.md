---
phase: 02-core-commands
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/openclawpack/commands/plan_phase.py
  - src/openclawpack/commands/execute_phase.py
  - tests/test_commands/test_plan_phase.py
  - tests/test_commands/test_execute_phase.py
autonomous: true
requirements:
  - CMD-02
  - CMD-03

must_haves:
  truths:
    - "Running `openclawpack plan-phase 2` invokes GSD `/gsd:plan-phase 2` non-interactively via the workflow engine with answer injection for any top-level questions"
    - "Running `openclawpack execute-phase 2` invokes GSD `/gsd:execute-phase 2` non-interactively via the workflow engine with checkpoint auto-approval"
    - "Both commands accept --timeout to override default timeouts (600s for plan-phase, 1200s for execute-phase)"
    - "Both commands return structured CommandResult JSON with session_id, usage, and duration_ms from the SDK response"
  artifacts:
    - path: "src/openclawpack/commands/plan_phase.py"
      provides: "plan_phase_workflow() function invoking GSD plan-phase with answer injection"
      exports: ["plan_phase_workflow"]
    - path: "src/openclawpack/commands/execute_phase.py"
      provides: "execute_phase_workflow() function invoking GSD execute-phase with checkpoint handling"
      exports: ["execute_phase_workflow"]
    - path: "tests/test_commands/test_plan_phase.py"
      provides: "Tests for plan-phase prompt construction, timeout, and answer map"
    - path: "tests/test_commands/test_execute_phase.py"
      provides: "Tests for execute-phase prompt construction, timeout, and checkpoint answer handling"
  key_links:
    - from: "src/openclawpack/commands/plan_phase.py"
      to: "src/openclawpack/commands/engine.py"
      via: "plan_phase_workflow calls WorkflowEngine.run_gsd_command()"
      pattern: "run_gsd_command"
    - from: "src/openclawpack/commands/execute_phase.py"
      to: "src/openclawpack/commands/engine.py"
      via: "execute_phase_workflow calls WorkflowEngine.run_gsd_command()"
      pattern: "run_gsd_command"
---

<objective>
Implement the plan-phase and execute-phase command workflows. These commands invoke GSD's `/gsd:plan-phase` and `/gsd:execute-phase` skills non-interactively via the workflow engine, handling any top-level questions through answer injection and auto-approving checkpoints.

Purpose: These are the two core GSD lifecycle commands that an AI agent needs to drive a project from planned to built. Together with new-project and status from Plan 02-02, they complete the full non-interactive GSD command surface.

Output: Working plan-phase and execute-phase commands with tests.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-commands/02-RESEARCH.md
@.planning/phases/02-core-commands/02-01-SUMMARY.md
@src/openclawpack/commands/engine.py
@src/openclawpack/commands/answers.py
@src/openclawpack/cli.py
@src/openclawpack/output/schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement plan-phase workflow with tests</name>
  <files>
    src/openclawpack/commands/plan_phase.py
    tests/test_commands/test_plan_phase.py
  </files>
  <action>
    **Create `src/openclawpack/commands/plan_phase.py`:**

    Contains:

    1. `PLAN_PHASE_DEFAULTS` dict — default answers for GSD plan-phase top-level questions. Based on research, plan-phase may ask about CONTEXT.md creation if missing, and confirmation prompts:
       ```python
       PLAN_PHASE_DEFAULTS: dict[str, str] = {
           "context": "Skip",        # Skip CONTEXT.md creation if missing
           "confirm": "Yes",         # Confirm plan breakdown
           "approve": "Yes",         # Approve generated plans
           "proceed": "Yes",         # Proceed with planning
       }
       ```
       Note: Most plan-phase work happens in subagents (researchers, planners, checkers) which run autonomously without AskUserQuestion. Only top-level confirmations need answers.

    2. `async def plan_phase_workflow(phase: int, project_dir: str | None = None, verbose: bool = False, quiet: bool = False, timeout: float | None = None, answer_overrides: dict[str, str] | None = None) -> CommandResult`:
       - Build answer map: `{**PLAN_PHASE_DEFAULTS, **(answer_overrides or {})}`
       - Create WorkflowEngine with project_dir, verbose, quiet, timeout (default 600s for plan-phase)
       - Call `await engine.run_gsd_command("gsd:plan-phase", prompt_args=str(phase), answer_map=answer_map)`
       - Return CommandResult

    3. `def plan_phase_workflow_sync(...)` — sync wrapper

    All imports lazy (inside function body).

    **Create `tests/test_commands/test_plan_phase.py`:**

    Tests (mock transport — no real Claude Code):
    1. `test_plan_phase_prompt_construction` — verify prompt is `/gsd:plan-phase 2` for phase=2
    2. `test_plan_phase_default_timeout` — verify default timeout is 600s
    3. `test_plan_phase_custom_timeout` — verify --timeout override works
    4. `test_plan_phase_default_answers` — verify PLAN_PHASE_DEFAULTS is used
    5. `test_plan_phase_answer_overrides` — verify overrides merge with defaults
    6. `test_plan_phase_project_dir_propagation` — verify project_dir reaches WorkflowEngine

    Use `unittest.mock.patch` on WorkflowEngine.run_gsd_command.
  </action>
  <verify>
    Run `python -m pytest tests/test_commands/test_plan_phase.py -v` — all tests pass.
    Run `openclawpack plan-phase --help` — shows phase argument and options.
  </verify>
  <done>
    `openclawpack plan-phase 2` constructs correct GSD prompt, uses 600s default timeout, pre-fills top-level questions, and returns structured CommandResult. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement execute-phase workflow with tests</name>
  <files>
    src/openclawpack/commands/execute_phase.py
    tests/test_commands/test_execute_phase.py
  </files>
  <action>
    **Create `src/openclawpack/commands/execute_phase.py`:**

    Contains:

    1. `EXECUTE_PHASE_DEFAULTS` dict — default answers for execute-phase questions. Execute-phase primarily asks about checkpoint approval and may ask about wave execution:
       ```python
       EXECUTE_PHASE_DEFAULTS: dict[str, str] = {
           "approve": "approved",    # Auto-approve checkpoints
           "approved": "approved",   # Alternative checkpoint wording
           "checkpoint": "approved", # Checkpoint verification prompt
           "continue": "Yes",        # Continue to next wave
           "proceed": "Yes",         # Proceed with execution
           "select": "option-a",     # Select first option at decision checkpoints
       }
       ```
       Note: GSD --auto mode auto-approves checkpoints and selects first options. The answer injection provides an additional safety layer for any prompts that bypass auto mode.

    2. `async def execute_phase_workflow(phase: int, project_dir: str | None = None, verbose: bool = False, quiet: bool = False, timeout: float | None = None, answer_overrides: dict[str, str] | None = None) -> CommandResult`:
       - Build answer map: `{**EXECUTE_PHASE_DEFAULTS, **(answer_overrides or {})}`
       - Create WorkflowEngine with project_dir, verbose, quiet, timeout (default 1200s for execute-phase — it runs multiple subagents in waves)
       - Call `await engine.run_gsd_command("gsd:execute-phase", prompt_args=str(phase), answer_map=answer_map)`
       - Return CommandResult

    3. `def execute_phase_workflow_sync(...)` — sync wrapper

    All imports lazy (inside function body).

    **Create `tests/test_commands/test_execute_phase.py`:**

    Tests (mock transport — no real Claude Code):
    1. `test_execute_phase_prompt_construction` — verify prompt is `/gsd:execute-phase 2` for phase=2
    2. `test_execute_phase_default_timeout` — verify default timeout is 1200s (longer than other commands because execute-phase runs multiple subagents)
    3. `test_execute_phase_custom_timeout` — verify --timeout override works
    4. `test_execute_phase_default_answers` — verify EXECUTE_PHASE_DEFAULTS includes checkpoint approval answers
    5. `test_execute_phase_answer_overrides` — verify overrides merge with defaults
    6. `test_execute_phase_project_dir_propagation` — verify project_dir reaches WorkflowEngine
    7. `test_execute_phase_checkpoint_answers` — verify answer map contains entries for "approve", "checkpoint", "continue" (the key checkpoint-related question patterns)

    Use `unittest.mock.patch` on WorkflowEngine.run_gsd_command.
  </action>
  <verify>
    Run `python -m pytest tests/test_commands/test_execute_phase.py -v` — all tests pass.
    Run `python -m pytest tests/test_commands/ -v` — all command tests pass.
    Run `openclawpack execute-phase --help` — shows phase argument and options.
    Run `python -m pytest tests/ -v` — full suite passes.
  </verify>
  <done>
    `openclawpack execute-phase 2` constructs correct GSD prompt, uses 1200s default timeout, pre-fills checkpoint approval and continuation answers, and returns structured CommandResult. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_commands/test_plan_phase.py tests/test_commands/test_execute_phase.py -v` — all tests pass
2. `openclawpack plan-phase --help` — shows phase argument and --timeout option
3. `openclawpack execute-phase --help` — shows phase argument and --timeout option
4. `python -m pytest tests/ -v` — full test suite passes
5. `openclawpack --help` — all 4 commands listed
</verification>

<success_criteria>
- plan-phase command invokes `/gsd:plan-phase N` with correct prompt, 600s default timeout, and top-level question answers
- execute-phase command invokes `/gsd:execute-phase N` with correct prompt, 1200s default timeout, and checkpoint auto-approval answers
- Both commands support --timeout override and answer overrides
- Both commands return structured CommandResult JSON
- All tests pass without requiring Claude Code
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-commands/02-03-SUMMARY.md`
</output>
