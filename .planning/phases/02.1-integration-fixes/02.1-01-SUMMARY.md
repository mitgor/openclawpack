---
phase: 02.1-integration-fixes
plan: 01
subsystem: transport
tags: [claude-agent-sdk, hooks, HookMatcher, AsyncIterable, can_use_tool]

requires:
  - phase: 02-core-commands
    provides: "ClaudeTransport adapter, answers.py callback builder"
provides:
  - "Fixed sdk_query() wiring -- can_use_tool/hooks on ClaudeAgentOptions fields"
  - "AsyncIterable prompt wrapping for streaming mode"
  - "HookMatcher-wrapped hooks via build_hooks_dict()"
  - "Verbose/quiet stderr control on transport"
  - "Strict SDK signature enforcement in test mocks"
affects: [02.1-02, engine, workflow-execution]

tech-stack:
  added: []
  patterns: ["options-field assignment over query kwargs", "AsyncIterable prompt wrapping"]

key-files:
  created: []
  modified:
    - "src/openclawpack/transport/client.py"
    - "src/openclawpack/commands/answers.py"
    - "tests/test_transport/test_client.py"
    - "tests/test_commands/test_answers.py"

key-decisions:
  - "can_use_tool/hooks set as ClaudeAgentOptions fields, not sdk_query() kwargs"
  - "Prompt wrapped as AsyncIterable when can_use_tool is set (SDK streaming requirement)"
  - "Hook callback uses 3-param signature (input, tool_use_id, context) -> dict"
  - "build_hooks_dict() lazy-imports HookMatcher to preserve PKG-04 compliance"
  - "quiet takes precedence over verbose when both set"

patterns-established:
  - "Strict sdk_query mock: async def fake_query(*, prompt, options, transport=None) enforces real signature"
  - "Options-field pattern: set per-call params on ClaudeAgentOptions, not as extra kwargs"

requirements-completed: [CMD-05]

duration: 4min
completed: 2026-02-22
---

# Plan 02.1-01: SDK Wiring Fixes Summary

**Fixed sdk_query() call to wire can_use_tool/hooks onto ClaudeAgentOptions fields with AsyncIterable prompt wrapping and 3-param hook callback signature**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-22
- **Completed:** 2026-02-22
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Removed query_kwargs pattern that passed can_use_tool/hooks as extra sdk_query() kwargs (which the SDK rejects)
- Added _wrap_prompt_as_stream() helper for AsyncIterable prompt when can_use_tool requires streaming mode
- Fixed build_noop_pretool_hook() from 2-param to 3-param SDK HookCallback signature returning dict
- Added build_hooks_dict() with HookMatcher wrapping for correct SDK hooks structure
- Added verbose/quiet kwargs to client.py for stderr output control
- Updated all test mocks to enforce strict sdk_query keyword-only 3-arg signature

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix client.py SDK wiring** - `6f280a4` (fix)
2. **Task 2: Fix answers.py hooks + strict test mocks** - `c9138b5` (fix)

## Files Created/Modified
- `src/openclawpack/transport/client.py` - Fixed sdk_query wiring, added prompt wrapper, verbose/quiet support
- `src/openclawpack/commands/answers.py` - Fixed hook signature, added build_hooks_dict() with HookMatcher
- `tests/test_transport/test_client.py` - Strict sdk_query mocks, new verbose/quiet tests
- `tests/test_commands/test_answers.py` - Tests for 3-param hook, build_hooks_dict structure

## Decisions Made
- Used Any types in hook callback to avoid SDK type imports (PKG-04 compliance)
- quiet takes precedence over verbose (defensive -- user asked for quiet)
- AsyncIterable check based on options.can_use_tool being set (not the raw kwarg)

## Deviations from Plan
None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- client.py ready for engine.py to forward verbose/quiet flags (Plan 02.1-02)
- build_hooks_dict() ready for engine.py to replace bare dict hooks (Plan 02.1-02)

---
*Phase: 02.1-integration-fixes*
*Completed: 2026-02-22*
