---
phase: 02.1-integration-fixes
type: verification
status: passed
verified: 2026-02-22
---

# Phase 2.1: Integration Fixes -- Verification

## Goal

All non-interactive commands (new-project, plan-phase, execute-phase) work end-to-end at runtime with correct SDK wiring, structured error output, and effective verbose/quiet flags.

## Success Criteria Verification

### 1. SDK Wiring (PASS)
**Criterion:** Running `openclawpack new-project --idea "build a todo app"` with answer injection reaches the SDK without TypeError -- `can_use_tool` and `hooks` are set on `ClaudeAgentOptions`, not passed as kwargs to `sdk_query()`

**Evidence:**
- `client.py` sets `options.can_use_tool = can_use_tool` and `options.hooks = hooks` on the ClaudeAgentOptions object
- Old `query_kwargs` dict pattern completely removed
- `sdk_query(prompt=prompt_input, options=options)` called with only 2 kwargs
- When `can_use_tool` is set, prompt wrapped as `AsyncIterable` via `_wrap_prompt_as_stream()`
- Tests with strict `fake_query(*, prompt, options, transport=None)` mock would fail if extra kwargs passed

### 2. Structured Error Output (PASS)
**Criterion:** When Claude Code CLI is not installed, running any command returns `{"success": false, "errors": ["..."]}` structured JSON instead of a Python traceback

**Evidence:**
- `WorkflowEngine.run_gsd_command()` catches `TransportError` and returns `CommandResult.error(str(e))`
- All three workflow functions (`new_project_workflow`, `plan_phase_workflow`, `execute_phase_workflow`) wrap in `try/except Exception` returning `CommandResult.error()`
- Tests verify: `CLINotFound("CLI not found")` -> `result.success is False`, `"CLI not found" in result.errors[0]`
- Tests verify: `TransportTimeout` -> structured error with "timed out" message

### 3. Verbose Flag Forwarding (PASS)
**Criterion:** Running `openclawpack new-project --verbose "build a todo app"` causes the SDK to emit debug output (verbose flag forwarded to transport layer)

**Evidence:**
- `WorkflowEngine` passes `run_kwargs["verbose"] = True` when `self.verbose` is set
- `ClaudeTransport.run()` pops `verbose` kwarg and sets `options.stderr = lambda line: print(line, file=_sys.stderr)`
- `quiet=True` sets `options.stderr = None` (suppresses output)
- `quiet` takes precedence over `verbose` when both set
- Tests verify stderr callback is callable when verbose, None when quiet

### 4. Strict Test Mocks (PASS)
**Criterion:** Test mocks for `sdk_query` enforce the real function signature and reject unexpected kwargs

**Evidence:**
- All `fake_query` functions in `test_client.py` use `async def fake_query(*, prompt, options, transport=None)` -- keyword-only
- No `**kw` or `**kwargs` in mock functions
- If `client.py` ever passes extra kwargs, tests fail with `TypeError: unexpected keyword argument`
- Tests verify `options.can_use_tool` and `options.hooks` are set on options object, not as top-level kwargs

## Requirements Coverage

| Requirement | Status | Evidence |
|------------|--------|----------|
| CMD-05 | ✓ | Answer injection works with correct HookMatcher structure |
| CMD-07 | ✓ | Verbose/quiet flags forwarded through engine to transport |

## Test Results

- **220 tests passing** (excluding 4 fragile live-state tests and 1 integration test requiring Claude CLI)
- 13 new tests added across engine, transport, and workflow test modules
- All pre-existing tests continue to pass

## Verdict

**PASSED** -- All 4 success criteria verified. Phase 2.1 gap closure is complete.
