---
phase: 03-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/openclawpack/transport/retry.py
  - src/openclawpack/transport/types.py
  - src/openclawpack/transport/errors.py
  - src/openclawpack/transport/client.py
  - src/openclawpack/transport/__init__.py
  - src/openclawpack/commands/engine.py
  - src/openclawpack/commands/new_project.py
  - src/openclawpack/commands/plan_phase.py
  - src/openclawpack/commands/execute_phase.py
  - src/openclawpack/cli.py
  - tests/test_transport/test_retry.py
  - tests/test_transport/test_client.py
  - tests/test_commands/test_engine.py
autonomous: true
requirements:
  - TRNS-05
  - TRNS-06

must_haves:
  truths:
    - "When a transient error (rate limit, connection drop) occurs, the transport retries with exponential backoff and jitter before surfacing the failure"
    - "Non-retryable errors (CLINotFound, JSONDecodeError, TransportTimeout) fail immediately without retry"
    - "A multi-step workflow can resume a previous Claude session by passing --resume <session_id> on the CLI"
    - "Session ID from one command can be captured from JSON output and fed to a subsequent command via --resume"
  artifacts:
    - path: "src/openclawpack/transport/retry.py"
      provides: "RetryPolicy dataclass, is_retryable() classifier, calculate_backoff() function"
      min_lines: 40
    - path: "src/openclawpack/transport/client.py"
      provides: "Retry loop wrapping SDK call, resume_session_id passthrough to ClaudeAgentOptions.resume"
      contains: "is_retryable"
    - path: "src/openclawpack/cli.py"
      provides: "--resume flag on new-project, plan-phase, execute-phase commands"
      contains: "--resume"
    - path: "tests/test_transport/test_retry.py"
      provides: "Tests for is_retryable(), calculate_backoff(), and RetryPolicy"
      min_lines: 50
  key_links:
    - from: "src/openclawpack/transport/client.py"
      to: "src/openclawpack/transport/retry.py"
      via: "import is_retryable, calculate_backoff, RetryPolicy"
      pattern: "from openclawpack\\.transport\\.retry import"
    - from: "src/openclawpack/transport/client.py"
      to: "ClaudeAgentOptions.resume"
      via: "options.resume = resume_session_id"
      pattern: "options\\.resume"
    - from: "src/openclawpack/cli.py"
      to: "workflow functions"
      via: "resume_session_id parameter forwarding"
      pattern: "resume_session_id"
    - from: "src/openclawpack/commands/engine.py"
      to: "src/openclawpack/transport/client.py"
      via: "resume_session_id kwarg to transport.run()"
      pattern: "resume_session_id"
---

<objective>
Add transport-level retry with exponential backoff and session resume via --resume CLI flag.

Purpose: TRNS-05 ensures commands survive transient failures (rate limits, connection drops) without manual re-runs. TRNS-06 enables multi-step workflows to maintain Claude conversation context by resuming a previous session ID.

Output: retry.py module with RetryPolicy/is_retryable/calculate_backoff, updated client.py with retry loop and resume passthrough, updated CLI with --resume flag, and tests.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-reliability/3-RESEARCH.md

@src/openclawpack/transport/client.py
@src/openclawpack/transport/types.py
@src/openclawpack/transport/errors.py
@src/openclawpack/transport/__init__.py
@src/openclawpack/commands/engine.py
@src/openclawpack/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create retry module and update transport config</name>
  <files>
    src/openclawpack/transport/retry.py
    src/openclawpack/transport/types.py
    src/openclawpack/transport/errors.py
    src/openclawpack/transport/__init__.py
    tests/test_transport/test_retry.py
  </files>
  <action>
Create `src/openclawpack/transport/retry.py` with:

1. **RetryPolicy** dataclass (NOT Pydantic -- follows TransportConfig convention):
   - `max_retries: int = 3`
   - `base_delay: float = 2.0` (seconds)
   - `max_delay: float = 60.0` (seconds)
   - `jitter: float = 0.5` (fraction of delay to randomize, 0.0-1.0)

2. **is_retryable(error: Exception) -> bool** function:
   - `CLINotFound` -> False (won't fix by retrying)
   - `JSONDecodeError` -> False (corrupt output won't self-heal)
   - `TransportTimeout` -> False (already waited the full timeout)
   - `ConnectionError_` -> True (transient connection issues)
   - `ProcessError` -> True (rate limits surface as process errors)
   - Any other exception -> False

3. **calculate_backoff(attempt: int, policy: RetryPolicy) -> float** function:
   - Formula: `min(policy.base_delay * (2 ** attempt), policy.max_delay)`
   - Add jitter: `delay + random.uniform(-jitter_range, jitter_range)` where `jitter_range = delay * policy.jitter`
   - Clamp result to minimum 0.0 (prevent negative delays from jitter)

Update `src/openclawpack/transport/types.py`:
- Import `RetryPolicy` from `openclawpack.transport.retry` (use `from __future__ import annotations` to avoid circular import -- retry.py imports from errors.py, not types.py, so no circular issue)
- Add `retry_policy: RetryPolicy = field(default_factory=RetryPolicy)` to `TransportConfig`
- Update docstring to document the new field

Update `src/openclawpack/transport/__init__.py`:
- Add `RetryPolicy` to direct imports from `openclawpack.transport.retry`
- Add `RetryPolicy` to `__all__`

Create `tests/test_transport/test_retry.py` with tests:
- `test_is_retryable_cli_not_found` -- returns False
- `test_is_retryable_json_decode_error` -- returns False
- `test_is_retryable_transport_timeout` -- returns False
- `test_is_retryable_connection_error` -- returns True
- `test_is_retryable_process_error` -- returns True
- `test_is_retryable_unknown_exception` -- returns False
- `test_calculate_backoff_exponential` -- verifies 2^attempt growth (attempt 0 -> ~2s, attempt 1 -> ~4s, attempt 2 -> ~8s)
- `test_calculate_backoff_max_delay_cap` -- verifies delay never exceeds max_delay
- `test_calculate_backoff_jitter_range` -- run 100 times, verify all results within expected range
- `test_calculate_backoff_zero_jitter` -- jitter=0.0 produces exact exponential
- `test_retry_policy_defaults` -- verify default values
  </action>
  <verify>
Run `python -m pytest tests/test_transport/test_retry.py -v` -- all tests pass.
Run `python -c "from openclawpack.transport import RetryPolicy; print(RetryPolicy())"` -- prints default policy.
  </verify>
  <done>
RetryPolicy, is_retryable(), and calculate_backoff() exist with full test coverage. TransportConfig includes a retry_policy field with sensible defaults.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add retry loop to client.py and session resume passthrough</name>
  <files>
    src/openclawpack/transport/client.py
    src/openclawpack/commands/engine.py
    src/openclawpack/commands/new_project.py
    src/openclawpack/commands/plan_phase.py
    src/openclawpack/commands/execute_phase.py
    src/openclawpack/cli.py
    tests/test_transport/test_client.py
    tests/test_commands/test_engine.py
  </files>
  <action>
**client.py changes:**

1. Refactor `ClaudeTransport.run()` into a retry wrapper + inner method:
   - Rename current run() body to `_run_once(self, prompt: str, **kwargs) -> CommandResult` (private method containing all existing logic PLUS resume support)
   - New `run()` becomes a retry loop that calls `_run_once()`:
     ```
     async def run(self, prompt, **kwargs):
         retry_policy = kwargs.pop("retry_policy", self.config.retry_policy)
         last_error = None
         for attempt in range(retry_policy.max_retries + 1):
             try:
                 return await self._run_once(prompt, **kwargs)
             except TransportError as e:
                 last_error = e
                 if not is_retryable(e) or attempt == retry_policy.max_retries:
                     raise
                 delay = calculate_backoff(attempt, retry_policy)
                 logger.warning("Transient error attempt %d/%d, retrying in %.1fs: %s", attempt+1, retry_policy.max_retries, delay, e)
                 await asyncio.sleep(delay)
         raise last_error
     ```
   - Add `import logging` and `logger = logging.getLogger(__name__)` at module level
   - Add import: `from openclawpack.transport.retry import RetryPolicy, calculate_backoff, is_retryable`

2. Add resume support to `_run_once()`:
   - Pop `resume_session_id = kwargs.pop("resume_session_id", None)` alongside existing can_use_tool/hooks/verbose/quiet pops
   - After building `options`, add: `if resume_session_id is not None: options.resume = resume_session_id`
   - Place this BEFORE the can_use_tool/hooks section

**engine.py changes:**

3. Add `resume_session_id` parameter to `WorkflowEngine.run_gsd_command()`:
   - New parameter: `resume_session_id: str | None = None`
   - Forward to transport: `run_kwargs["resume_session_id"] = resume_session_id` (only when not None)
   - Also accept on `__init__`: `self.resume_session_id = resume_session_id`
   - In `run_gsd_command()`, use `resume_session_id or self.resume_session_id` -- parameter overrides instance default
   - Update sync wrapper signature similarly

**Workflow file changes (new_project.py, plan_phase.py, execute_phase.py):**

4. Add `resume_session_id: str | None = None` parameter to each async workflow function.
   - Forward it to `WorkflowEngine.__init__()`: `resume_session_id=resume_session_id`
   - Update sync wrapper to pass it through
   - Do NOT change the answer maps or other logic

**cli.py changes:**

5. Add `--resume` option to `new-project`, `plan-phase`, and `execute-phase` commands:
   ```python
   resume: Optional[str] = typer.Option(
       None,
       "--resume",
       help="Resume a previous Claude session by session ID.",
   ),
   ```
   - Forward `resume_session_id=resume` to the async workflow function call
   - Do NOT add --resume to `status` command (status is local-only, no Claude session)

**Test updates:**

6. Update `tests/test_transport/test_client.py`:
   - Add `test_run_retries_on_transient_error`: mock `_run_once` to raise `ConnectionError_` twice then succeed. Verify 3 calls total and success result. Use a `RetryPolicy(base_delay=0.01)` to keep tests fast.
   - Add `test_run_no_retry_on_fatal_error`: mock `_run_once` to raise `CLINotFound`. Verify raised immediately, 1 call total.
   - Add `test_run_exhausts_retries`: mock `_run_once` to always raise `ProcessError`. Verify raises after max_retries+1 attempts.
   - Add `test_run_forwards_resume_session_id`: mock `sdk_query`, verify `options.resume` is set when resume_session_id provided.

7. Update `tests/test_commands/test_engine.py`:
   - Add `test_engine_forwards_resume_session_id`: create engine with resume_session_id, mock transport, verify it appears in run kwargs.
  </action>
  <verify>
Run `python -m pytest tests/test_transport/test_client.py tests/test_transport/test_retry.py tests/test_commands/test_engine.py -v` -- all tests pass.
Run `python -m pytest tests/test_cli.py -v` -- existing CLI tests still pass (no regressions).
Run `python -c "from openclawpack.cli import app; from typer.testing import CliRunner; r = CliRunner().invoke(app, ['plan-phase', '--help']); assert '--resume' in r.output"` -- --resume flag appears in help.
  </verify>
  <done>
Transport retries transient errors with exponential backoff. Non-retryable errors fail immediately. --resume flag passes session IDs through CLI -> workflow -> engine -> transport -> SDK. All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -v` -- all tests pass (no regressions)
2. `python -c "from openclawpack.transport.retry import RetryPolicy, is_retryable, calculate_backoff; print('OK')"` -- retry module imports cleanly
3. `python -c "from openclawpack.transport import RetryPolicy; print(RetryPolicy())"` -- RetryPolicy exported from transport package
4. `python -c "from openclawpack.cli import app; from typer.testing import CliRunner; r = CliRunner().invoke(app, ['new-project', '--help']); assert '--resume' in r.output; print('OK')"` -- --resume on new-project
5. `python -c "from openclawpack.cli import app; from typer.testing import CliRunner; r = CliRunner().invoke(app, ['plan-phase', '--help']); assert '--resume' in r.output; print('OK')"` -- --resume on plan-phase
6. `python -c "from openclawpack.cli import app; from typer.testing import CliRunner; r = CliRunner().invoke(app, ['execute-phase', '--help']); assert '--resume' in r.output; print('OK')"` -- --resume on execute-phase
</verification>

<success_criteria>
- RetryPolicy, is_retryable(), calculate_backoff() exist and are tested
- ClaudeTransport.run() wraps _run_once() in retry loop using RetryPolicy from config
- Transient errors (ConnectionError_, ProcessError) are retried; fatal errors (CLINotFound, JSONDecodeError, TransportTimeout) are not
- Session resume flows from CLI --resume -> workflow -> engine -> transport -> SDK options.resume
- All existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/03-reliability/03-01-SUMMARY.md`
</output>
