---
phase: 04-library-api-and-events
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/openclawpack/events/__init__.py
  - src/openclawpack/events/types.py
  - src/openclawpack/events/bus.py
  - src/openclawpack/events/cli_handler.py
  - src/openclawpack/output/schema.py
  - tests/test_events/__init__.py
  - tests/test_events/test_bus.py
  - tests/test_events/test_types.py
  - tests/test_events/test_cli_handler.py
autonomous: true
requirements:
  - INT-02
  - INT-03
  - INT-04

must_haves:
  truths:
    - "EventBus.on() registers handlers and emit_async() calls them with the correct Event"
    - "EventBus handles both sync and async handlers without crashing"
    - "EventBus.emit() works synchronously and skips async handlers with a warning"
    - "cli_json_handler writes event JSON lines to stderr when called"
    - "EventType enum has exactly 5 members: phase_complete, plan_complete, error, decision_needed, progress_update"
    - "Event.to_json_line() produces valid JSON containing type and data"
    - "ProjectStatus is a Pydantic model with current_phase, progress_percent, blockers, and requirement counts"
    - "Handler exceptions are logged but do not crash emit_async or emit"
  artifacts:
    - path: "src/openclawpack/events/types.py"
      provides: "EventType enum and Event Pydantic model"
      contains: "class EventType"
    - path: "src/openclawpack/events/bus.py"
      provides: "EventBus class with on/off/emit/emit_async"
      contains: "class EventBus"
    - path: "src/openclawpack/events/cli_handler.py"
      provides: "cli_json_handler function for CLI mode"
      contains: "def cli_json_handler"
    - path: "src/openclawpack/events/__init__.py"
      provides: "Re-exports EventBus, EventType, Event"
      exports: ["EventBus", "EventType", "Event"]
    - path: "src/openclawpack/output/schema.py"
      provides: "ProjectStatus typed model"
      contains: "class ProjectStatus"
  key_links:
    - from: "src/openclawpack/events/bus.py"
      to: "src/openclawpack/events/types.py"
      via: "imports Event and EventType"
      pattern: "from openclawpack\\.events\\.types import"
    - from: "src/openclawpack/events/cli_handler.py"
      to: "src/openclawpack/events/types.py"
      via: "imports Event for type annotation"
      pattern: "from openclawpack\\.events\\.types import Event"
    - from: "src/openclawpack/events/__init__.py"
      to: "src/openclawpack/events/bus.py"
      via: "re-exports EventBus"
      pattern: "from openclawpack\\.events\\.bus import EventBus"
---

<objective>
Build the event system foundation (EventBus, EventType, Event models) and typed ProjectStatus model.

Purpose: Provide the pub/sub infrastructure that INT-03 and INT-04 require, plus the typed status model that INT-02 requires. This is the foundation that Plan 02 (library API facade) builds on.

Output: `src/openclawpack/events/` package with EventBus, types, and CLI handler; `ProjectStatus` model in output/schema.py; comprehensive tests for all event system behavior.
</objective>

<execution_context>
@/Users/mit/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mit/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-library-api-and-events/4-RESEARCH.md
@src/openclawpack/output/schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create event types and EventBus with TDD</name>
  <files>
    src/openclawpack/events/__init__.py
    src/openclawpack/events/types.py
    src/openclawpack/events/bus.py
    tests/test_events/__init__.py
    tests/test_events/test_types.py
    tests/test_events/test_bus.py
  </files>
  <action>
**RED phase -- write failing tests first:**

Create `tests/test_events/__init__.py` (empty) and `tests/test_events/test_types.py`:
- Test `EventType` is a `str, Enum` with exactly 5 members: `PHASE_COMPLETE`, `PLAN_COMPLETE`, `ERROR`, `DECISION_NEEDED`, `PROGRESS_UPDATE` with lowercase string values.
- Test `Event` is a Pydantic `BaseModel` with `type: EventType` and `data: dict[str, Any]` defaulting to `{}`.
- Test `Event.to_json_line()` returns valid JSON string containing `"type"` and `"data"` keys.
- Test `Event` can be constructed with just a type (data defaults to empty dict).

Create `tests/test_events/test_bus.py`:
- Test `EventBus()` creates an instance with no handlers.
- Test `bus.on(EventType.ERROR, handler)` registers a handler and `emit_async` calls it with the correct `Event`.
- Test `bus.off(EventType.ERROR, handler)` removes it so emit_async no longer calls it.
- Test `emit_async` with a sync handler (non-coroutine callable) -- should work fine.
- Test `emit_async` with an async handler (coroutine function) -- should await it.
- Test `emit_async` with multiple handlers on the same event type -- all are called.
- Test `emit_async` when handler raises an exception -- logs error but does not propagate (use caplog or mock logger).
- Test `emit()` (sync) calls sync handlers and warns (log) when skipping async handlers.
- Test `emit_async` with no handlers registered for the event type -- no error.
- Test handlers receive an `Event` object with the correct `type` and `data`.

Run `pytest tests/test_events/` -- all tests MUST fail (RED).

**GREEN phase -- implement minimally:**

Create `src/openclawpack/events/types.py`:
```python
from __future__ import annotations
from enum import Enum
from typing import Any
from pydantic import BaseModel

class EventType(str, Enum):
    PHASE_COMPLETE = "phase_complete"
    PLAN_COMPLETE = "plan_complete"
    ERROR = "error"
    DECISION_NEEDED = "decision_needed"
    PROGRESS_UPDATE = "progress_update"

class Event(BaseModel):
    type: EventType
    data: dict[str, Any] = {}

    def to_json_line(self) -> str:
        return self.model_dump_json()
```

Create `src/openclawpack/events/bus.py`:
Follow the research Pattern 2 exactly. Key details:
- `EventHandler = Union[Callable[[Event], None], Callable[[Event], Coroutine[Any, Any, None]]]`
- `_handlers: dict[EventType, list[EventHandler]]` using `defaultdict(list)`
- `on()` appends handler, `off()` removes handler
- `emit_async()`: creates `Event`, iterates handlers, uses `asyncio.iscoroutine()` to detect and await async results. Catches exceptions and logs them via `logging.getLogger(__name__)`.
- `emit()`: sync version. Creates `Event`, iterates handlers, calls sync ones, for async handlers calls `result.close()` and logs a warning.

Create `src/openclawpack/events/__init__.py`:
```python
from openclawpack.events.bus import EventBus
from openclawpack.events.types import Event, EventType
__all__ = ["EventBus", "Event", "EventType"]
```

Run `pytest tests/test_events/` -- all tests MUST pass (GREEN).

**REFACTOR if needed** -- clean up, ensure docstrings present.
  </action>
  <verify>
Run `pytest tests/test_events/test_types.py tests/test_events/test_bus.py -v` -- all tests pass.
Run `python -c "from openclawpack.events import EventBus, EventType, Event; print('OK')"` -- prints OK.
  </verify>
  <done>
EventType enum has 5 members with correct string values. Event is a Pydantic model with to_json_line(). EventBus supports on/off/emit/emit_async with both sync and async handlers. Handler errors are logged, not propagated. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CLI event handler and ProjectStatus model with TDD</name>
  <files>
    src/openclawpack/events/cli_handler.py
    src/openclawpack/output/schema.py
    tests/test_events/test_cli_handler.py
    tests/test_output/test_schema.py
  </files>
  <action>
**RED phase -- write failing tests first:**

Create `tests/test_events/test_cli_handler.py`:
- Test `cli_json_handler(event)` writes to stderr (not stdout) using `capsys`.
- Test output starts with `"event: "` prefix followed by valid JSON.
- Test the JSON payload contains `"type"` and `"data"` keys matching the input event.
- Test handler works for each of the 5 EventType values.
- Test `cli_json_handler` is a sync (non-async) function (important for INT-04 CLI mode).

Add tests to `tests/test_output/test_schema.py` (create if not exists):
- Test `ProjectStatus` is a Pydantic model.
- Test `ProjectStatus` has fields: `current_phase: int`, `current_phase_name: str`, `progress_percent: float`, `blockers: list[str]`, `requirements_complete: int`, `requirements_total: int`.
- Test `ProjectStatus` can be serialized to JSON via `model_dump_json()`.
- Test `ProjectStatus` defaults: `blockers` defaults to `[]`.

Run tests -- MUST fail (RED).

**GREEN phase -- implement:**

Create `src/openclawpack/events/cli_handler.py`:
```python
import sys
from openclawpack.events.types import Event

def cli_json_handler(event: Event) -> None:
    """Write event as a JSON line to stderr (avoids conflicting with stdout JSON output)."""
    print(f"event: {event.to_json_line()}", file=sys.stderr, flush=True)
```

Modify `src/openclawpack/output/schema.py` -- add `ProjectStatus` class ABOVE the existing `CommandResult` class:
```python
class ProjectStatus(BaseModel):
    """Typed status result for library consumers (INT-02)."""
    current_phase: int
    current_phase_name: str
    progress_percent: float
    blockers: list[str] = Field(default_factory=list)
    requirements_complete: int
    requirements_total: int
```

Do NOT modify the existing `CommandResult` class or its methods. Only add `ProjectStatus` alongside it.

Run tests -- MUST pass (GREEN).
  </action>
  <verify>
Run `pytest tests/test_events/test_cli_handler.py tests/test_output/test_schema.py -v` -- all pass.
Run `python -c "from openclawpack.events.cli_handler import cli_json_handler; print('OK')"` -- prints OK.
Run `python -c "from openclawpack.output.schema import ProjectStatus; print(ProjectStatus(current_phase=1, current_phase_name='Foundation', progress_percent=50.0, requirements_complete=5, requirements_total=10).model_dump_json())"` -- prints valid JSON.
  </verify>
  <done>
cli_json_handler writes "event: {json}" to stderr for each event. ProjectStatus is a typed Pydantic model with all required fields. All existing tests in test_output still pass (no regression). New tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/test_events/ -v` -- all event system tests pass
2. `pytest tests/test_output/ -v` -- all output tests pass (including ProjectStatus + existing CommandResult tests)
3. `pytest tests/ -v` -- full suite passes (no regressions)
4. `python -c "from openclawpack.events import EventBus, EventType, Event; b = EventBus(); b.on(EventType.ERROR, lambda e: print(e)); print('OK')"` -- imports work, handler registration works
5. `openclawpack --version` -- still works (PKG-04 not broken by new modules)
</verification>

<success_criteria>
- EventBus class with on/off/emit/emit_async is importable and tested
- EventType enum has exactly 5 string members
- Event is a Pydantic model with type + data + to_json_line()
- cli_json_handler writes JSON event lines to stderr
- ProjectStatus Pydantic model exists with typed fields
- All tests pass, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-library-api-and-events/04-01-SUMMARY.md`
</output>
